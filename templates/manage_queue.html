<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Queue</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1800ad",
              accent1: "#ff2e00",
              accent2: "#ff9900",
              accent3: "#ff75ca",
            },
          },
        },
      };
    </script>
    <meta http-equiv="refresh" content="30" />
  </head>
  <body class="bg-gray-50">
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center space-x-2">
            <img
              src="{{ url_for('static', filename='logo.png') }}"
              alt="NexTurn"
              class="h-8 w-8"
            />
            <span class="text-xl font-bold text-gray-900" id="business-name"
              >Loading...</span
            >
          </div>
          <div class="flex items-center space-x-4">
            <a
              href="{{ url_for('business_dashboard') }}"
              class="text-gray-700 hover:text-primary"
              >Dashboard</a
            >
            <a
              href="{{ url_for('logout') }}"
              class="text-gray-700 hover:text-accent1"
              >Logout</a
            >
          </div>
        </div>
      </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900" id="queue-name">
          Loading...
        </h1>
        <p class="text-gray-600 mt-2" id="queue-service-time">Loading...</p>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="space-y-2 mb-6">
        {% for category, message in messages %}
        <div
          class="rounded-lg px-4 py-3 {% if category=='success' %}bg-green-50 text-green-800 border border-green-200{% elif category=='info' %}bg-blue-50 text-blue-800 border border-blue-200{% else %}bg-red-50 text-red-800 border border-red-200{% endif %}"
        >
          {{ message }}
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <!-- Analytics -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-sm font-medium text-gray-500 mb-2">
            Total Customers Served
          </h3>
          <p class="text-3xl font-bold text-primary" id="total-served">-</p>
        </div>
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-sm font-medium text-gray-500 mb-2">
            Average Wait Time
          </h3>
          <p class="text-3xl font-bold text-accent2" id="avg-wait-time">-</p>
        </div>
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-sm font-medium text-gray-500 mb-2">
            Current Queue Size
          </h3>
          <p class="text-3xl font-bold text-accent3" id="queue-size">0</p>
        </div>
      </div>

      <!-- Active Queue -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Active Queue</h2>
          <button
            id="serve-next-btn"
            onclick="serveNextCustomer()"
            class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition hidden"
          >
            Serve Next Customer
          </button>
        </div>

        <div id="tickets-container">
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">Loading queue data...</p>
          </div>
        </div>
      </div>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-500">
          Page auto-refreshes every 30 seconds
        </p>
      </div>
    </div>

    <script src="{{ url_for('static', filename='api-config.js') }}"></script>
    <script src="{{ url_for('static', filename='queue.js') }}"></script>
    <script>
      let currentQueueId = null;
      let currentBusinessId = null;

      // Get queue_id and business_id from URL
      function getQueueIdFromURL() {
        const path = window.location.pathname;
        const match = path.match(/\/business\/(\d+)\/queue\/(\d+)/);
        if (match) {
          currentBusinessId = parseInt(match[1]);
          currentQueueId = parseInt(match[2]);
          return currentQueueId;
        }
        return null;
      }

      // Load queue data
      async function loadQueueData() {
        const queueId = getQueueIdFromURL();
        if (!queueId) {
          console.error("Queue ID not found in URL");
          return;
        }

        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login";
          return;
        }

        try {
          // Fetch queue details
          const queueResponse = await fetch(`/api/queues/${queueId}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const queueData = await queueResponse.json();

          if (queueData.success && queueData.data.queue) {
            const queue = queueData.data.queue;

            // Update page title and header
            document.getElementById("queue-name").textContent = queue.name;
            document.title = `Manage Queue - ${queue.name}`;
            document.getElementById(
              "queue-service-time"
            ).textContent = `Average service time: ${queue.avg_service_time} minutes`;

            // Update analytics
            document.getElementById("queue-size").textContent = queue.size || 0;

            // Fetch business info for business name
            if (currentBusinessId) {
              try {
                const businessResponse = await fetch(
                  `/api/businesses/${currentBusinessId}`,
                  {
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                  }
                );
                const businessData = await businessResponse.json();
                if (businessData.success && businessData.data.business) {
                  document.getElementById("business-name").textContent =
                    businessData.data.business.name;
                }
              } catch (error) {
                console.error("Error fetching business:", error);
              }
            }

            // Display tickets
            displayTickets(queue.active_tickets || []);
          } else {
            console.error("Failed to load queue:", queueData);
            document.getElementById("tickets-container").innerHTML =
              '<div class="text-center py-12"><p class="text-red-500 text-lg">Failed to load queue data</p></div>';
          }
        } catch (error) {
          console.error("Error loading queue data:", error);
          document.getElementById("tickets-container").innerHTML =
            '<div class="text-center py-12"><p class="text-red-500 text-lg">Error loading queue data</p></div>';
        }
      }

      // Display tickets in table
      function displayTickets(tickets) {
        const container = document.getElementById("tickets-container");
        const serveNextBtn = document.getElementById("serve-next-btn");

        if (!tickets || tickets.length === 0) {
          container.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-500 text-lg">No customers in queue</p>
                        <p class="text-sm text-gray-400 mt-2">Queue is empty - waiting for customers to join</p>
                    </div>
                `;
          serveNextBtn.classList.add("hidden");
          return;
        }

        serveNextBtn.classList.remove("hidden");

        // Format join time
        function formatTime(timestamp) {
          if (!timestamp) return "N/A";
          const date = new Date(timestamp);
          return date.toLocaleString();
        }

        container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket ID</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tickets
                              .map(
                                (ticket, index) => `
                                <tr ${index === 0 ? 'class="bg-green-50"' : ""}>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-3 py-1 inline-flex text-lg leading-5 font-semibold rounded-full
                                            ${
                                              index === 0
                                                ? "bg-green-100 text-green-800"
                                                : "bg-gray-100 text-gray-800"
                                            }">
                                            #${ticket.position}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        ${ticket.user_id}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${formatTime(ticket.join_time)}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                                        ${
                                          ticket.ticket_id
                                            ? ticket.ticket_id.substring(0, 8) +
                                              "..."
                                            : "N/A"
                                        }
                                    </td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;
      }

      // Serve next customer
      async function serveNextCustomer() {
        if (!currentQueueId) return;

        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login";
          return;
        }

        if (!confirm("Are you sure you want to serve the next customer?")) {
          return;
        }

        try {
          const response = await fetch(
            `/api/queues/${currentQueueId}/serve-next`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const data = await response.json();

          if (data.success) {
            alert("Customer served successfully!");
            // Reload queue data
            loadQueueData();
          } else {
            alert(data.message || data.error || "Failed to serve customer");
          }
        } catch (error) {
          console.error("Error serving next customer:", error);
          alert("An error occurred while serving the customer");
        }
      }

      // Load data on page load
      document.addEventListener("DOMContentLoaded", loadQueueData);
    </script>
  </body>
</html>
